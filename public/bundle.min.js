"use strict";var app=angular.module("app",["ui.router","angular-cache"]);app.constant("HTTP_RESPONSES",{NoResponse:-1,OK:200,Created:201,MovedPermanently:301,BadRequest:400,Forbidden:403,NotFound:404,MethodNotAllowed:405,UnsupportedMediaType:415,TooManyRequests:429,InternalServerError:500,NotImplemented:501,ServiceUnavailable:503}),console.log("YO"),app.constant("USER_ROLES",{User:1,UserManager:2,Admin:3}),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",signupSuccess:"auth-signup-success",signupFailed:"auth-signup-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),app.config(["$stateProvider","$urlRouterProvider","$locationProvider","USER_ROLES",function(e,t,a,r){a.html5Mode(!0),t.otherwise("/jogs"),t.rule(function(e,t){var a=t.path(),r="/"===a[a.length-1];if(r){var o=a.substr(0,a.length-1);return o}}),e.state("auth",{abstract:!0,templateUrl:"/app/pages/auth/auth.view.html",controller:"authController"}).state("auth.login",{url:"/login"}).state("auth.signup",{url:"/signup"}).state("home",{abstract:!0,templateUrl:"/app/pages/home/home.view.html",controller:"homeController"}).state("home.jogs",{url:"/jogs",data:{authorizedRoles:[r.User,r.UserManager,r.Admin]}})}]),app.run(["$rootScope","$state","AuthFactory","AUTH_EVENTS",function(e,t,a,r){e.$on("$stateChangeStart",function(t,o){o.data&&o.data.authorizedRoles&&(a.isAuthorized(o.data.authorizedRoles)||(t.preventDefault(),a.isAuthenticated()?e.$broadcast(r.notAuthorized):e.$broadcast(r.notAuthenticated)))}),e.$on(r.notAuthenticated,function(){t.go("auth.login")})}]),app.controller("rootController",["$scope","$state",function(e,t){e.app_test="APP WORKING"}]),angular.module("app").constant("API_URL","http://localhost:3000/api");var app=angular.module("app");app.factory("ApiFactory",["$http","CacheFactory","API_URL","HTTP_RESPONSES",function(e,t,a,r){function o(e,t){var a=[];for(var r in e)a.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return a.join("&")}var n={};return n.request=function(n,s,u){return new Promise(function(i,l){if(["POST","GET","PUT","DELETE"].indexOf(n)===-1)throw new Error("received unsupported HTTP method");if("string"!=typeof s)throw new Error("endpoint must be a string");"/"!==s[0]&&(s="/"+s);var c={method:n,url:a+s,headers:{}};if("POST"!==n&&"PUT"!==n||(c.headers["Content-Type"]="application/x-www-form-urlencoded",c.transformRequest=o),t.get("authCache")){var d=t.get("authCache"),p=d.get("user");p&&(d.info("user").isExpired||(c.headers.Authorization=p.token))}u&&("POST"!==n&&"PUT"!==n||(c.data=u),"GET"===n&&(c.params=u)),e(c).then(function(e){return i({status:e.status,payload:e.data.payload})},function(e){return l(e?{status:e.status,payload:e.data.payload}:{status:r.NoResponse,payload:null})})})},n}]);var app=angular.module("app");app.factory("AuthFactory",["$http","CacheFactory","ApiFactory",function(e,t,a){var r={},o=void 0;return o=t.get("authCache")?t.get("authCache"):t("authCache",{storageMode:"localStorage",maxAge:432e5,deleteOnExpire:"aggressive",recycleFreq:6e4}),r.getUser=function(){var e=o.get("user");return e?o.info("user").isExpired?null:e.user:null},r.login=function(e){return new Promise(function(t,r){a.request("POST","/user/authenticate",e).then(function(e){return o.put("user",{token:e.payload.token,user:e.payload.user}),t()},r)})},r.signup=function(e){var t=angular.copy(e);return t.name=JSON.stringify(e.name),new Promise(function(e,r){a.request("POST","/user",t).then(function(t){return o.put("user",{token:t.payload.token,user:t.payload.user}),e()},r)})},r.isAuthenticated=function(){return!!r.getUser()._id},r.isAuthorized=function(e){return angular.isArray(e)||(e=[e]),r.isAuthenticated()&&e.indexOf(r.getUser().role)!==-1},r}]);var app=angular.module("app");app.controller("authController",["$scope","$rootScope","$state","AuthFactory","AUTH_EVENTS","HTTP_RESPONSES","$timeout",function(e,t,a,r,o,n,s){e.errorMessage="",e.getErrorMessage=function(){return e.errorMessage},e.credentials={name:{first:"",last:""},email:"",password:""},e.isLoginForm=function(){return"auth.login"===a.current.name},e.login=function(u){r.login(u).then(function(){t.$broadcast(o.loginSuccess),a.go("home.jogs")},function(a){t.$broadcast(o.loginFailed),s(function(){switch(a.status){case n.NotFound:e.errorMessage="Oops! That user doesn't exist.";break;case n.BadRequest:a.payload.InvalidArguments?(e.errorMessage="Some fields were invalid!",console.error("Invalid arguments:",a.payload.InvalidArguments)):"user already exists"===a.payload.message?e.errorMessage="An account already exists for that email.":e.errorMessage="Something went wrong. This is embarassing.";break;case n.Forbidden:e.errorMessage="Hmmm. Wrong password.";break;case n.InternalServerError:e.errorMessage="Something went wrong. This is embarassing."}})})},e.signup=function(u){r.signup(u).then(function(){t.$broadcast(o.signupSuccess),a.go("home.jogs")},function(a){t.$broadcast(o.signupFailed),s(function(){switch(a.status){case n.NotFound:e.errorMessage="Oops! That user doesn't exist.";break;case n.BadRequest:a.payload.InvalidArguments?(e.errorMessage="Some fields were invalid!",console.error("Invalid arguments:",a.payload.InvalidArguments)):"user already exists"===a.payload.message?e.errorMessage="An account already exists for that email.":e.errorMessage="Something went wrong. This is embarassing.";break;case n.Forbidden:e.errorMessage="Hmmm. Wrong password.";break;case n.InternalServerError:e.errorMessage="Something went wrong. This is embarassing."}})})}}]);var app=angular.module("app");app.controller("homeController",["$scope",function(e){}]);