"use strict";var app=angular.module("app",["ui.router","angular-cache","ngMaterial"]);app.constant("HTTP_RESPONSES",{NoResponse:-1,OK:200,Created:201,MovedPermanently:301,BadRequest:400,Forbidden:403,NotFound:404,MethodNotAllowed:405,UnsupportedMediaType:415,TooManyRequests:429,InternalServerError:500,NotImplemented:501,ServiceUnavailable:503}),app.constant("USER_ROLES",{User:1,UserManager:2,Admin:3}),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",signupSuccess:"auth-signup-success",signupFailed:"auth-signup-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),app.config(["$stateProvider","$urlRouterProvider","$locationProvider","USER_ROLES","$compileProvider","$mdDateLocaleProvider",function(e,t,a,r,n,o){n.preAssignBindingsEnabled(!0),o.formatDate=function(e){var t=e.getDate(),a=e.getMonth(),r=e.getFullYear();return t+"/"+(a+1)+"/"+r},o.parseDate=function(e){var t=e.split("/");if(3!==t.length)return new Date(NaN);try{return new Date(parseInt(t[2],10),parseInt(t[1],10)-1,parseInt(t[0],10))}catch(e){return new Date(NaN)}},a.html5Mode(!0),t.otherwise("/jogs"),t.rule(function(e,t){var a=t.path(),r="/"===a[a.length-1];if(r){var n=a.substr(0,a.length-1);return n}}),e.state("auth",{abstract:!0,templateUrl:"/app/pages/auth/auth.view.html",controller:"authController"}).state("auth.login",{url:"/login"}).state("auth.signup",{url:"/signup"}).state("home",{abstract:!0,templateUrl:"/app/pages/home/home.view.html",controller:"homeController"}).state("home.jogs",{url:"/jogs",templateUrl:"/app/pages/home/jogs/jogs.view.html",controller:"jogsController",data:{authorizedRoles:[r.User,r.UserManager,r.Admin]}}).state("home.reports",{url:"/reports",data:{authorizedRoles:[r.User,r.UserManager,r.Admin]}}).state("home.manage-users",{url:"/manage-users",data:{authorizedRoles:[r.UserManager,r.Admin]}})}]),app.run(["$rootScope","$state","AuthFactory","AUTH_EVENTS",function(e,t,a,r){e.$on("$stateChangeStart",function(t,n){n.data&&n.data.authorizedRoles&&(a.isAuthorized(n.data.authorizedRoles)||(t.preventDefault(),a.isAuthenticated()?e.$broadcast(r.notAuthorized):e.$broadcast(r.notAuthenticated)))}),e.$on(r.notAuthenticated,function(){t.go("auth.login")})}]),app.controller("rootController",["$scope","$state",function(e,t){e.app_test="APP WORKING"}]),angular.module("app").constant("API_URL","https://project-jogging-tracker.herokuapp.com/api");var app=angular.module("app");app.factory("ApiFactory",["$http","CacheFactory","API_URL","HTTP_RESPONSES",function(e,t,a,r){function n(e,t){var a=[];for(var r in e)a.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return a.join("&")}var o={};return o.request=function(o,s,u){return new Promise(function(i,c){if(["POST","GET","PUT","DELETE"].indexOf(o)===-1)throw new Error("received unsupported HTTP method");if("string"!=typeof s)throw new Error("endpoint must be a string");"/"!==s[0]&&(s="/"+s);var l={method:o,url:a+s,headers:{}};if("POST"!==o&&"PUT"!==o||(l.headers["Content-Type"]="application/x-www-form-urlencoded",l.transformRequest=n),t.get("authCache")){var p=t.get("authCache"),g=p.get("user");g&&(p.info("user").isExpired||(l.headers.Authorization=g.token))}u&&("POST"!==o&&"PUT"!==o||(l.data=u),"GET"===o&&(l.params=u)),e(l).then(function(e){return i({status:e.status,payload:e.data.payload})},function(e){return c(e?{status:e.status,payload:e.data.payload}:{status:r.NoResponse,payload:null})})})},o}]);var app=angular.module("app");app.factory("AuthFactory",["$http","CacheFactory","ApiFactory",function(e,t,a){var r={},n=void 0;return n=t.get("authCache")?t.get("authCache"):t("authCache",{storageMode:"localStorage",maxAge:432e5,deleteOnExpire:"aggressive",recycleFreq:6e4}),r.getUser=function(){var e=n.get("user");return e?n.info("user").isExpired?null:e.user:null},r.login=function(e){return new Promise(function(t,r){a.request("POST","/user/authenticate",e).then(function(e){return n.put("user",{token:e.payload.token,user:e.payload.user}),t()},r)})},r.signup=function(e){var t=angular.copy(e);return t.name=JSON.stringify(e.name),new Promise(function(e,r){a.request("POST","/user",t).then(function(t){return n.put("user",{token:t.payload.token,user:t.payload.user}),e()},r)})},r.isAuthenticated=function(){return!!r.getUser()&&!!r.getUser()._id},r.isAuthorized=function(e){return angular.isArray(e)||(e=[e]),r.isAuthenticated()&&e.indexOf(r.getUser().role)!==-1},r}]);var app=angular.module("app");app.factory("JogFactory",["ApiFactory",function(e){var t={};return t.getJogs=function(){return new Promise(function(t,a){e.request("GET","/jog").then(function(e){return t(e.payload)},a)})},t}]);var app=angular.module("app");app.controller("authController",["$scope","$rootScope","$state","AuthFactory","AUTH_EVENTS","HTTP_RESPONSES","$timeout",function(e,t,a,r,n,o,s){e.errorMessage="",e.getErrorMessage=function(){return e.errorMessage},e.credentials={name:{first:"",last:""},email:"",password:""},e.isLoginForm=function(){return"auth.login"===a.current.name},e.login=function(u){r.login(u).then(function(){t.$broadcast(n.loginSuccess),a.go("home.jogs")},function(a){t.$broadcast(n.loginFailed),s(function(){switch(a.status){case o.NotFound:e.errorMessage="Oops! That user doesn't exist.";break;case o.BadRequest:a.payload.InvalidArguments?(e.errorMessage="Some fields were invalid!",console.error("Invalid arguments:",a.payload.InvalidArguments)):"user already exists"===a.payload.message?e.errorMessage="An account already exists for that email.":e.errorMessage="Something went wrong. This is embarassing.";break;case o.Forbidden:e.errorMessage="Hmmm. Wrong password.";break;case o.InternalServerError:e.errorMessage="Something went wrong. This is embarassing."}})})},e.signup=function(u){r.signup(u).then(function(){t.$broadcast(n.signupSuccess),a.go("home.jogs")},function(a){t.$broadcast(n.signupFailed),s(function(){switch(a.status){case o.NotFound:e.errorMessage="Oops! That user doesn't exist.";break;case o.BadRequest:a.payload.InvalidArguments?(e.errorMessage="Some fields were invalid!",console.error("Invalid arguments:",a.payload.InvalidArguments)):"user already exists"===a.payload.message?e.errorMessage="An account already exists for that email.":e.errorMessage="Something went wrong. This is embarassing.";break;case o.Forbidden:e.errorMessage="Hmmm. Wrong password.";break;case o.InternalServerError:e.errorMessage="Something went wrong. This is embarassing."}})})}}]);var app=angular.module("app");app.controller("homeController",["$scope","$state","AuthFactory","USER_ROLES",function(e,t,a,r){e.navOpen=!1,e.isNavOpen=function(){return e.navOpen},e.toggleNavOpen=function(){e.navOpen=!e.navOpen},e.getState=function(){return t.current.name},e.getPageTitle=function(){switch(t.current.name){case"home.jogs":return"My Jogs";case"home.reports":return"Reports";case"home.manage-users":return"Manage Users";default:return""}},e.showMenuItem=function(e){var r=t.get(e);return a.isAuthorized(r.data.authorizedRoles)}}]);var app=angular.module("app");app.controller("jogsController",["$scope","JogFactory","HTTP_RESPONSES","$timeout",function(e,t,a,r){var n=new Date;n.setDate(n.getDate()-7),e.date={from:n,to:new Date},e.jogs=[],e.getJogs=function(){return e.jogs},t.getJogs().then(function(t){r(function(){e.jogs=t})},function(e){switch(e.status){case a.NotFound:break;case a.BadRequest:break;case a.Forbidden:break;case a.InternalServerError:}})}]);